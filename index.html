<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SkyPulse</title>
  <style>
    :root{
      --bg:#0a0e27;
      --panel:#1a1f3a;
      --panel2: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.12);
      --text:#f0f4f8;
      --muted:#8b92a9;
      --primary:#3b82f6;
      --success:#10b981;
      --warning:#f59e0b;
      --danger:#ef4444;
      --shadow: 0 20px 60px rgba(0,0,0,.5);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,sans-serif}
    body{
      display:flex;align-items:center;justify-content:center;
      background-image:
        radial-gradient(700px 420px at 20% 10%, rgba(59,130,246,0.16), transparent 55%),
        radial-gradient(700px 420px at 80% 90%, rgba(16,185,129,0.12), transparent 55%);
      overflow:hidden;
    }

    .app{
      width:min(1020px, 96vw);
      height:min(680px, 94vh);
      display:grid;
      grid-template-columns: 1fr 330px;
      gap:16px;
      padding:16px;
    }
    @media (max-width: 940px){
      body{overflow:auto}
      .app{grid-template-columns:1fr; height:auto}
      .right{order:-1}
    }

    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    /* Game panel */
    .game-header{
      display:flex;align-items:center;justify-content:space-between;
      padding:12px 14px;
      background:rgba(0,0,0,.14);
      border-bottom:1px solid var(--border);
      gap:12px;
    }
    .brand{
      display:flex;align-items:center;gap:10px;font-weight:950;letter-spacing:-0.6px;
      min-width: 140px;
    }
    .brand .logo{font-size:18px}
    .brand .name{font-size:15px}
    .hud{
      display:flex;align-items:center;gap:10px;
      font-size:12px;color:var(--muted);font-weight:850;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      padding:6px 10px;border-radius:999px;background:var(--panel2);
      border:1px solid var(--border);
      color:var(--text);
      white-space:nowrap;
    }
    .btn-icon{
      width:38px;height:38px;border-radius:12px;
      border:1px solid var(--border);background:var(--panel2);
      color:var(--text);cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      transition:.15s;
      font-size:16px;
      flex:0 0 auto;
    }
    .btn-icon:hover{transform:translateY(-1px);background:rgba(255,255,255,.09)}
    .canvas-wrap{
      position:relative;
      height: calc(100% - 57px);
      display:flex;align-items:center;justify-content:center;
      padding:14px;
    }
    canvas{
      width:100%;
      height:100%;
      max-height:560px;
      border-radius:14px;
      background: linear-gradient(180deg, rgba(59,130,246,.18), rgba(16,185,129,.10));
      border:1px solid var(--border);
      display:block;
      touch-action: manipulation;
    }

    .overlay{
      position:absolute;inset:14px;
      display:flex;align-items:center;justify-content:center;
      pointer-events:none;
    }
    .overlay .panel{
      pointer-events:none;
      width:min(520px, 94%);
      text-align:center;
      background:rgba(10,14,39,.86);
      border:1px solid var(--border);
      border-radius:16px;
      padding:18px 16px;
      backdrop-filter: blur(10px);
    }
    .title{font-size:18px;font-weight:950;margin-bottom:8px}
    .subtitle{font-size:13px;color:var(--muted);line-height:1.4}
    .kbd{
      display:inline-flex;gap:8px;align-items:center;justify-content:center;
      margin-top:12px;
      font-size:12px;color:var(--muted)
    }
    .kbd span{
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      border-radius:10px;
      padding:6px 10px;
      color:var(--text);
      font-weight:950;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }
    .toast{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      bottom:22px;
      background:rgba(0,0,0,.35);
      border:1px solid var(--border);
      padding:8px 12px;
      border-radius:999px;
      font-size:12px;
      color:var(--text);
      display:none;
      backdrop-filter: blur(10px);
      pointer-events:none;
      max-width: 90%;
      text-overflow: ellipsis;
      overflow:hidden;
      white-space:nowrap;
    }
    .toast.show{display:block; animation: toastIn .18s ease-out}
    @keyframes toastIn{from{opacity:0; transform:translateX(-50%) translateY(6px)} to{opacity:1; transform:translateX(-50%) translateY(0)}}

    /* Right panel */
    .right{display:flex;flex-direction:column;gap:12px}
    .panel-title{
      padding:12px 14px;
      font-size:12px;
      font-weight:950;
      letter-spacing:1px;
      text-transform:uppercase;
      color:var(--muted);
      border-bottom:1px solid var(--border);
      background:rgba(0,0,0,.12);
    }
    .panel-body{padding:14px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 0;border-bottom:1px solid var(--border)}
    .row:last-child{border-bottom:none}
    .label{font-size:13px;font-weight:950}
    .value{font-size:12px;color:var(--muted);font-weight:850}

    .btn{
      width:100%;
      border:0;
      border-radius:12px;
      background:linear-gradient(135deg,var(--primary),#1d4ed8);
      color:white;
      font-weight:950;
      padding:12px 14px;
      cursor:pointer;
      transition:.15s;
      display:flex;align-items:center;justify-content:center;gap:10px;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px);box-shadow:0 12px 30px rgba(59,130,246,.35)}
    .btn.secondary{
      background:var(--panel2);
      border:1px solid var(--border);
      color:var(--text);
      box-shadow:none;
    }
    .btn.secondary:hover{background:rgba(255,255,255,.09);transform:translateY(-1px)}
    .small{font-size:12px;color:var(--muted);line-height:1.45;margin-top:10px}
    .chiprow{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .chip{
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.05);
      font-size:12px;
      font-weight:900;
      color:var(--text);
      cursor:pointer;
      transition:.15s;
      user-select:none;
    }
    .chip:hover{background:rgba(255,255,255,.08);transform:translateY(-1px)}
    .chip.on{border-color:rgba(16,185,129,.45); background:rgba(16,185,129,.12)}
    .chip.warn{border-color:rgba(245,158,11,.45); background:rgba(245,158,11,.10)}
    .chip.danger{border-color:rgba(239,68,68,.45); background:rgba(239,68,68,.10)}

    /* Footer links */
    .footerbar{
      padding:10px 14px;
      border-top:1px solid var(--border);
      background:rgba(0,0,0,.12);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .footerlinks{
      display:flex;gap:10px;flex-wrap:wrap;
      font-size:12px;
    }
    .footerlinks a{
      color:var(--muted);
      text-decoration:none;
      font-weight:850;
      padding:6px 8px;
      border-radius:10px;
      border:1px solid transparent;
      transition:.15s;
    }
    .footerlinks a:hover{
      color:var(--text);
      background:rgba(255,255,255,.05);
      border-color:var(--border);
    }
    .footright{
      color:var(--muted);
      font-size:12px;
      font-weight:800;
    }

    /* Modal */
    .modal{
      position:fixed;inset:0;
      display:none;align-items:center;justify-content:center;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      z-index:1000;
      padding:16px;
    }
    .modal.show{display:flex}
    .modal-card{
      width:min(820px, 96vw);
      max-height: min(86vh, 720px);
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .modal-head{
      display:flex;align-items:center;justify-content:space-between;
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      background:rgba(0,0,0,.14);
    }
    .tabs{
      display:flex;gap:6px;
      padding:10px 14px;
      border-bottom:1px solid var(--border);
      background:rgba(255,255,255,.03);
      flex-wrap:wrap;
    }
    .tab{
      padding:8px 10px;border-radius:10px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.05);
      color:var(--muted);
      font-weight:950;font-size:12px;
      cursor:pointer;
      transition:.15s;
      user-select:none;
    }
    .tab.active{
      background:rgba(59,130,246,.18);
      color:var(--text);
      border-color:rgba(59,130,246,.35);
    }
    .modal-body{
      padding:14px;
      overflow:auto;
    }
    .section{display:none}
    .section.active{display:block}
    .hr{height:1px;background:var(--border);margin:12px 0}

    .toggle{
      width:48px;height:26px;border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      position:relative;cursor:pointer;transition:.15s;
      flex:0 0 auto;
    }
    .toggle::after{
      content:"";
      position:absolute;top:2px;left:2px;
      width:22px;height:22px;border-radius:50%;
      background:white;transition:.15s;
    }
    .toggle.on{background:rgba(59,130,246,.35);border-color:rgba(59,130,246,.55)}
    .toggle.on::after{left:24px}

    .select{
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.25);
      color:var(--text);
      font-weight:950;
      outline:none;
    }

    .callout{
      border:1px solid rgba(16,185,129,.35);
      background:rgba(16,185,129,.10);
      border-radius:14px;
      padding:12px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-top:12px;
    }
    .callout b{font-size:13px}
    .callout span{display:block;font-size:12px;color:var(--muted);line-height:1.35;margin-top:4px}

    .earnpro-box{
      border:1px solid rgba(59,130,246,.35);
      background:rgba(59,130,246,.12);
      border-radius:14px;
      padding:12px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      margin-top:10px;
    }
    .earnpro-box .left{
      display:flex;flex-direction:column;gap:4px;
    }
    .earnpro-box .left b{font-size:13px}
    .earnpro-box .left span{font-size:12px;color:var(--muted);line-height:1.3}
    .earnpro-btn{
      padding:10px 12px;border-radius:12px;border:0;
      background:linear-gradient(135deg,var(--primary),#1d4ed8);
      color:white;font-weight:950;cursor:pointer;white-space:nowrap;
      transition:.15s;
      user-select:none;
    }
    .earnpro-btn:hover{transform:translateY(-1px);box-shadow:0 12px 30px rgba(59,130,246,.25)}
    .earnpro-hidden{display:none}

    .doc h3{
      margin:8px 0 6px;
      font-size:14px;
      font-weight:950;
      letter-spacing:-0.2px;
    }
    .doc p, .doc li{
      font-size:12.5px;
      color:var(--muted);
      line-height:1.55;
    }
    .doc ul{padding-left:18px;margin:8px 0}
    .doc code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--border);
      padding:2px 6px;
      border-radius:8px;
      color:var(--text);
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Game -->
    <div class="card">
      <div class="game-header">
        <div class="brand">
          <span class="logo">‚ö°</span>
          <span class="name">SkyPulse</span>
        </div>

        <div class="hud">
          <span class="pill">Score: <span id="score">0</span></span>
          <span class="pill">Best: <span id="best">0</span></span>
          <span class="pill">Speed: <span id="speed">1.0x</span></span>
          <button class="btn-icon" id="settingsBtn" title="Settings">‚öôÔ∏è</button>
        </div>
      </div>

      <div class="canvas-wrap">
        <canvas id="game" width="900" height="560"></canvas>
        <div class="overlay" id="overlay">
          <div class="panel">
            <div class="title" id="overlayTitle">Tap to start</div>
            <div class="subtitle" id="overlaySubtitle">
              Fly through the gates. Don‚Äôt hit the pipes or the ground.
            </div>
            <div class="kbd">
              <span>Space</span> <span>Click</span> <span>Tap</span>
            </div>
          </div>
        </div>
        <div class="toast" id="toast"></div>
      </div>

      <div class="footerbar">
        <div class="footerlinks">
          <a href="#" data-doc="about">About</a>
          <a href="#" data-doc="privacy">Privacy</a>
          <a href="#" data-doc="terms">Terms</a>
          <a href="#" data-doc="contact">Contact</a>
        </div>
        <div class="footright">¬© <span id="year"></span> SkyPulse</div>
      </div>
    </div>

    <!-- Right panel -->
    <div class="right">
      <div class="card">
        <div class="panel-title">Quick Controls</div>
        <div class="panel-body">
          <button class="btn" id="playBtn">‚ñ∂Ô∏è Play / Restart</button>
          <div style="height:10px"></div>
          <button class="btn secondary" id="pauseBtn">‚è∏Ô∏è Pause</button>

          <div class="chiprow">
            <div class="chip on" id="soundChip">üîä Sound</div>
            <div class="chip" id="hapticsChip">üì≥ Haptics</div>
            <div class="chip warn" id="practiceChip">üß™ Practice</div>
          </div>

          <div class="small">
            Tip: Press <b>Space</b> to boost. In Practice mode, speed stays low.
          </div>
        </div>
      </div>

      <div class="card">
        <div class="panel-title">Stats</div>
        <div class="panel-body">
          <div class="row">
            <div class="label">Gates passed</div>
            <div class="value"><span id="pipesPassed">0</span></div>
          </div>
          <div class="row">
            <div class="label">Attempts</div>
            <div class="value"><span id="attempts">0</span></div>
          </div>
          <div class="row">
            <div class="label">Mode</div>
            <div class="value"><span id="modeLabel">Normal</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings modal -->
  <div class="modal" id="settingsModal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <div class="brand" style="gap:10px">
          <span class="logo">‚öôÔ∏è</span>
          <span class="name">Settings</span>
        </div>
        <button class="btn-icon" id="closeSettings" title="Close">‚úï</button>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="gameplay">Gameplay</button>
        <button class="tab" data-tab="more" id="moreTabBtn">More</button>
        <button class="tab" data-tab="docs">Docs</button>
      </div>

      <div class="modal-body">
        <div class="section active" id="tab-gameplay">
          <div class="row">
            <div>
              <div class="label">Hard Mode</div>
              <div class="value">Smaller gaps + faster pipes</div>
            </div>
            <div class="toggle" id="hardToggle" role="switch" aria-checked="false"></div>
          </div>

          <div class="row">
            <div>
              <div class="label">Style</div>
              <div class="value">Clean or neon</div>
            </div>
            <select class="select" id="gfxSelect" style="max-width: 220px;">
              <option value="clean" selected>Clean</option>
              <option value="neon">Neon</option>
            </select>
          </div>

          <div class="row">
            <div>
              <div class="label">Difficulty curve</div>
              <div class="value">Speed increases with score</div>
            </div>
            <div class="toggle on" id="curveToggle" role="switch" aria-checked="true"></div>
          </div>

          <div class="callout">
            <div>
              <b>Fair play</b>
              <span>
                SkyPulse runs only when the tab is visible. Pause anytime.
              </span>
            </div>
            <div style="font-size:18px; opacity:.9;">‚úÖ</div>
          </div>
        </div>

        <div class="section" id="tab-more">
          <div class="doc">
            <h3>Secret access</h3>
            <p>
              Tap the <code>More</code> tab <b>5 times</b> to reveal a hidden option.
            </p>
          </div>

          <div class="earnpro-box earnpro-hidden" id="earnproBox">
            <div class="left">
              <b>EarnPro</b>
              <span>Open EarnPro (login required).</span>
            </div>
            <button class="earnpro-btn" id="earnproBtn">Open</button>
          </div>

          <div class="hr"></div>

          <div class="doc">
            <h3>Quick links</h3>
            <ul>
              <li><a href="#" data-doc="about" style="color:var(--text);text-decoration:none;font-weight:900;">About</a></li>
              <li><a href="#" data-doc="privacy" style="color:var(--text);text-decoration:none;font-weight:900;">Privacy Policy</a></li>
              <li><a href="#" data-doc="terms" style="color:var(--text);text-decoration:none;font-weight:900;">Terms of Service</a></li>
              <li><a href="#" data-doc="contact" style="color:var(--text);text-decoration:none;font-weight:900;">Contact</a></li>
            </ul>
          </div>
        </div>

        <div class="section" id="tab-docs">
          <div class="doc" id="docsContent"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // -------------------------
    // SkyPulse (polished Flappy-style)
    // -------------------------
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');

    // UI
    const scoreEl = document.getElementById('score');
    const bestEl = document.getElementById('best');
    const speedEl = document.getElementById('speed');
    const pipesPassedEl = document.getElementById('pipesPassed');
    const attemptsEl = document.getElementById('attempts');
    const modeLabelEl = document.getElementById('modeLabel');
    const yearEl = document.getElementById('year');
    yearEl.textContent = new Date().getFullYear();

    const overlay = document.getElementById('overlay');
    const overlayTitle = document.getElementById('overlayTitle');
    const overlaySubtitle = document.getElementById('overlaySubtitle');
    const toast = document.getElementById('toast');

    // Settings modal
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsModal = document.getElementById('settingsModal');
    const closeSettings = document.getElementById('closeSettings');
    const tabs = Array.from(document.querySelectorAll('.tab'));
    const sections = {
      gameplay: document.getElementById('tab-gameplay'),
      more: document.getElementById('tab-more'),
      docs: document.getElementById('tab-docs')
    };

    const hardToggle = document.getElementById('hardToggle');
    const curveToggle = document.getElementById('curveToggle');
    const gfxSelect = document.getElementById('gfxSelect');
    const earnproBtn = document.getElementById('earnproBtn');
    const earnproBox = document.getElementById('earnproBox');
    const moreTabBtn = document.getElementById('moreTabBtn');
    const docsContent = document.getElementById('docsContent');

    // Buttons
    const playBtn = document.getElementById('playBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const soundChip = document.getElementById('soundChip');
    const hapticsChip = document.getElementById('hapticsChip');
    const practiceChip = document.getElementById('practiceChip');

    // Storage
    const STORE_KEY = 'skypulse:v2';
    const store = {
      load(){ try { return JSON.parse(localStorage.getItem(STORE_KEY) || '{}'); } catch { return {}; } },
      save(v){ localStorage.setItem(STORE_KEY, JSON.stringify(v)); }
    };
    const saved = store.load();

    // Settings state
    const settings = {
      hard: !!saved.hard,
      gfx: saved.gfx || 'clean',
      curve: (saved.curve ?? true) === true,
      sound: (saved.sound ?? true) === true,
      haptics: !!saved.haptics,
      practice: !!saved.practice,
    };

    // Secret taps
    let moreTapCount = 0;
    let moreTapTimer = null;
    let earnproUnlocked = !!saved.earnproUnlocked;

    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add('show');
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => toast.classList.remove('show'), 1400);
    }

    function vibrate(ms){
      if (!settings.haptics) return;
      try{ navigator.vibrate?.(ms); } catch {}
    }

    // Simple ‚Äúbeep‚Äù using WebAudio (no external files)
    let audioCtx = null;
    function beep(freq=640, dur=0.05, type='sine', gain=0.03){
      if (!settings.sound) return;
      try{
        audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = type;
        o.frequency.value = freq;
        g.gain.value = gain;
        o.connect(g);
        g.connect(audioCtx.destination);
        o.start();
        setTimeout(() => { o.stop(); }, Math.max(10, dur*1000));
      } catch {}
    }

    function syncSettingsUI(){
      hardToggle.classList.toggle('on', settings.hard);
      hardToggle.setAttribute('aria-checked', settings.hard ? 'true' : 'false');

      curveToggle.classList.toggle('on', settings.curve);
      curveToggle.setAttribute('aria-checked', settings.curve ? 'true' : 'false');

      gfxSelect.value = settings.gfx;

      soundChip.classList.toggle('on', settings.sound);
      hapticsChip.classList.toggle('on', settings.haptics);
      practiceChip.classList.toggle('on', settings.practice);

      modeLabelEl.textContent = settings.practice ? 'Practice' : (settings.hard ? 'Hard' : 'Normal');

      earnproBox.classList.toggle('earnpro-hidden', !earnproUnlocked);
    }

    function persist(){
      store.save({
        ...store.load(),
        hard: settings.hard,
        gfx: settings.gfx,
        curve: settings.curve,
        sound: settings.sound,
        haptics: settings.haptics,
        practice: settings.practice,
        best,
        attempts,
        earnproUnlocked
      });
    }

    // Game state
    let running = false;
    let paused = false;
    let startedOnce = false;

    let score = 0;
    let best = Number(saved.best || 0);
    let attempts = Number(saved.attempts || 0);
    let pipesPassed = 0;

    bestEl.textContent = best;
    attemptsEl.textContent = attempts;
    pipesPassedEl.textContent = pipesPassed;

    // Physics tuned for smoother feel
    const WORLD = {
      g: 0.58,
      flap: -9.8,
      speedBase: 3.2,
      speed: 3.2,
      pipeW: 78,
      gap: 160,
      spawnEvery: 1300, // ms
      groundH: 70,
      curveStep: 0.06, // speed increase per score
      curveMax: 1.6,   // max multiplier
    };

    const bird = {
      x: 220,
      y: canvas.height * 0.46,
      r: 16,
      vy: 0,
      tilt: 0
    };

    let pipes = [];
    let lastSpawn = 0;
    let lastTs = 0;

    // Visibility pause
    document.addEventListener('visibilitychange', () => {
      if (document.hidden && running && !paused){
        paused = true;
        pauseBtn.textContent = '‚ñ∂Ô∏è Resume';
        overlay.style.display = 'flex';
        overlayTitle.textContent = 'Paused';
        overlaySubtitle.textContent = 'Come back when you‚Äôre ready.';
      }
      if (!document.hidden && running && paused){
        // don‚Äôt auto-resume; user chooses
      }
    });

    function applyDifficulty(){
      if (settings.practice){
        WORLD.speedBase = 2.7;
        WORLD.gap = 178;
        WORLD.flap = -9.4;
        WORLD.spawnEvery = 1450;
        WORLD.g = 0.56;
      } else if (settings.hard){
        WORLD.speedBase = 3.9;
        WORLD.gap = 138;
        WORLD.flap = -10.1;
        WORLD.spawnEvery = 1220;
        WORLD.g = 0.62;
      } else {
        WORLD.speedBase = 3.2;
        WORLD.gap = 160;
        WORLD.flap = -9.8;
        WORLD.spawnEvery = 1300;
        WORLD.g = 0.58;
      }
      WORLD.speed = WORLD.speedBase;
      updateSpeedUI();
    }

    function speedMultiplier(){
      if (!settings.curve || settings.practice) return 1.0;
      const mult = 1.0 + Math.min(score * WORLD.curveStep, WORLD.curveMax - 1.0);
      return mult;
    }

    function updateSpeedUI(){
      const mult = WORLD.speed / WORLD.speedBase;
      speedEl.textContent = mult.toFixed(1) + 'x';
    }

    function resetGame(showOverlay=true){
      applyDifficulty();
      running = false;
      paused = false;

      score = 0;
      pipesPassed = 0;

      bird.y = canvas.height * 0.46;
      bird.vy = 0;
      bird.tilt = 0;

      pipes = [];
      lastSpawn = 0;
      lastTs = 0;

      scoreEl.textContent = '0';
      pipesPassedEl.textContent = '0';
      speedEl.textContent = '1.0x';

      if (showOverlay){
        overlay.style.display = 'flex';
        overlayTitle.textContent = startedOnce ? 'Tap to restart' : 'Tap to start';
        overlaySubtitle.textContent = 'Click / tap / Space to boost. Avoid pipes & ground.';
      } else {
        overlay.style.display = 'none';
      }
      pauseBtn.textContent = '‚è∏Ô∏è Pause';
    }

    function startRun(){
      if (running) return;
      running = true;
      paused = false;
      startedOnce = true;

      overlay.style.display = 'none';

      attempts++;
      attemptsEl.textContent = attempts;

      persist();
      beep(520, 0.05, 'sine', 0.03);
      vibrate(20);

      requestAnimationFrame(loop);
    }

    function togglePause(){
      if (!running) return;
      paused = !paused;
      pauseBtn.textContent = paused ? '‚ñ∂Ô∏è Resume' : '‚è∏Ô∏è Pause';
      if (paused){
        overlay.style.display = 'flex';
        overlayTitle.textContent = 'Paused';
        overlaySubtitle.textContent = 'Tap Resume to continue.';
      } else {
        overlay.style.display = 'none';
        lastTs = 0;
        requestAnimationFrame(loop);
      }
    }

    function flap(){
      if (!running) startRun();
      if (paused) return;
      bird.vy = WORLD.flap;
      beep(760, 0.03, 'square', 0.02);
      vibrate(10);
    }

    function spawnPipe(){
      const topMin = 44;
      const ceiling = 0;
      const groundY = canvas.height - WORLD.groundH;
      const topMax = groundY - WORLD.gap - 44;
      const topH = Math.floor(topMin + Math.random() * Math.max(10, (topMax - topMin)));
      pipes.push({ x: canvas.width + 28, topH, passed: false });
    }

    function rectCircleCollide(rx, ry, rw, rh, cx, cy, cr){
      const nx = Math.max(rx, Math.min(cx, rx + rw));
      const ny = Math.max(ry, Math.min(cy, ry + rh));
      const dx = cx - nx;
      const dy = cy - ny;
      return (dx*dx + dy*dy) <= cr*cr;
    }

    function die(){
      running = false;
      overlay.style.display = 'flex';
      overlayTitle.textContent = 'Game Over';
      overlaySubtitle.textContent = 'Tap Play / Restart to try again.';

      beep(220, 0.12, 'sawtooth', 0.03);
      vibrate(60);

      if (score > best){
        best = score;
        bestEl.textContent = best;
        showToast('New best! üî•');
      }

      persist();
    }

    // Drawing
    function drawBackground(){
      ctx.clearRect(0,0,canvas.width,canvas.height);

      // soft moving ‚Äústars‚Äù based on score
      const starOffset = (score * 7) % canvas.width;

      ctx.globalAlpha = 0.22;
      for (let i=0;i<55;i++){
        const x = (i*73 + starOffset) % canvas.width;
        const y = (i*137) % (canvas.height - WORLD.groundH);
        ctx.fillStyle = '#fff';
        ctx.fillRect(x, y, 2, 2);
      }
      ctx.globalAlpha = 1;

      // ground
      ctx.fillStyle = 'rgba(0,0,0,0.26)';
      ctx.fillRect(0, canvas.height - WORLD.groundH, canvas.width, WORLD.groundH);

      // subtle floor pattern
      ctx.globalAlpha = 0.22;
      for (let x=0; x<canvas.width; x+=34){
        ctx.fillStyle = 'rgba(255,255,255,0.14)';
        ctx.fillRect(x, canvas.height - WORLD.groundH + 20, 18, 6);
      }
      ctx.globalAlpha = 1;
    }

    function drawPipes(){
      const pipeColor = settings.gfx === 'neon' ? 'rgba(59,130,246,0.95)' : 'rgba(16,185,129,0.92)';
      const pipeEdge = settings.gfx === 'neon' ? 'rgba(59,130,246,0.32)' : 'rgba(16,185,129,0.28)';

      for (const p of pipes){
        // top pipe
        ctx.fillStyle = pipeColor;
        ctx.fillRect(p.x, 0, WORLD.pipeW, p.topH);

        // bottom pipe
        const bottomY = p.topH + WORLD.gap;
        const bottomH = (canvas.height - WORLD.groundH) - bottomY;
        ctx.fillRect(p.x, bottomY, WORLD.pipeW, bottomH);

        // edge
        ctx.strokeStyle = pipeEdge;
        ctx.lineWidth = 3;
        ctx.strokeRect(p.x+1, 1, WORLD.pipeW-2, p.topH-2);
        ctx.strokeRect(p.x+1, bottomY+1, WORLD.pipeW-2, bottomH-2);

        // cap
        ctx.globalAlpha = 0.22;
        ctx.fillStyle = '#000';
        ctx.fillRect(p.x, p.topH-8, WORLD.pipeW, 8);
        ctx.fillRect(p.x, bottomY, WORLD.pipeW, 8);
        ctx.globalAlpha = 1;
      }
    }

    function drawBird(){
      // tilt based on velocity
      bird.tilt = Math.max(-0.6, Math.min(0.8, bird.vy / 12));

      const body = settings.gfx === 'neon' ? 'rgba(245,158,11,0.95)' : 'rgba(240,244,248,0.92)';
      const outline = 'rgba(0,0,0,0.22)';

      ctx.save();
      ctx.translate(bird.x, bird.y);
      ctx.rotate(bird.tilt);

      // body
      ctx.beginPath();
      ctx.fillStyle = body;
      ctx.arc(0, 0, bird.r, 0, Math.PI*2);
      ctx.fill();

      // outline
      ctx.strokeStyle = outline;
      ctx.lineWidth = 3;
      ctx.stroke();

      // shadow
      ctx.globalAlpha = 0.18;
      ctx.beginPath();
      ctx.fillStyle = '#000';
      ctx.ellipse(-6, 6, 11, 7, 0.2, 0, Math.PI*2);
      ctx.fill();
      ctx.globalAlpha = 1;

      // eye
      ctx.beginPath();
      ctx.fillStyle = '#0b102a';
      ctx.arc(6, -4, 3, 0, Math.PI*2);
      ctx.fill();

      // beak
      ctx.beginPath();
      ctx.fillStyle = 'rgba(239,68,68,0.95)';
      ctx.moveTo(bird.r, 0);
      ctx.lineTo(bird.r + 12, -5);
      ctx.lineTo(bird.r + 12, 5);
      ctx.closePath();
      ctx.fill();

      ctx.restore();
    }

    function loop(ts){
      if (!running || paused) return;

      if (!lastTs) lastTs = ts;
      const dt = Math.min(34, ts - lastTs); // clamp dt for stability
      lastTs = ts;

      // spawn
      if (!lastSpawn) lastSpawn = ts;
      if (ts - lastSpawn >= WORLD.spawnEvery){
        spawnPipe();
        lastSpawn = ts;
      }

      // speed curve
      WORLD.speed = WORLD.speedBase * speedMultiplier();
      updateSpeedUI();

      // physics
      const scale = dt / 16.67;
      bird.vy += WORLD.g * scale;
      bird.y += bird.vy * scale;

      const sp = WORLD.speed * scale;

      // move pipes + scoring
      for (const p of pipes){
        p.x -= sp;
        if (!p.passed && p.x + WORLD.pipeW < bird.x){
          p.passed = true;
          score++;
          pipesPassed++;

          scoreEl.textContent = String(score);
          pipesPassedEl.textContent = String(pipesPassed);

          beep(980, 0.03, 'sine', 0.025);
          vibrate(8);
        }
      }
      pipes = pipes.filter(p => p.x + WORLD.pipeW > -60);

      const groundY = canvas.height - WORLD.groundH;
      if (bird.y + bird.r >= groundY) return die();
      if (bird.y - bird.r <= 0) return die();

      // collisions
      for (const p of pipes){
        if (rectCircleCollide(p.x, 0, WORLD.pipeW, p.topH, bird.x, bird.y, bird.r)) return die();
        const bottomY = p.topH + WORLD.gap;
        const bottomH = groundY - bottomY;
        if (rectCircleCollide(p.x, bottomY, WORLD.pipeW, bottomH, bird.x, bird.y, bird.r)) return die();
      }

      // render
      drawBackground();
      drawPipes();
      drawBird();

      requestAnimationFrame(loop);
    }

    // Input
    window.addEventListener('keydown', (e) => {
      if (e.code === 'Space'){
        e.preventDefault();
        flap();
      }
      if (e.code === 'KeyP') togglePause();
      if (e.code === 'KeyR') { resetGame(false); startRun(); }
    });

    canvas.addEventListener('pointerdown', () => flap());

    overlay.addEventListener('pointerdown', () => {
      if (!running){
        resetGame(false);
        startRun();
      }
    });

    playBtn.addEventListener('click', () => { resetGame(false); startRun(); });
    pauseBtn.addEventListener('click', () => togglePause());

    // Chips
    soundChip.addEventListener('click', () => {
      settings.sound = !settings.sound;
      syncSettingsUI();
      persist();
      showToast(settings.sound ? 'Sound on' : 'Sound off');
      if (settings.sound) beep(660, 0.04, 'sine', 0.03);
    });

    hapticsChip.addEventListener('click', () => {
      settings.haptics = !settings.haptics;
      syncSettingsUI();
      persist();
      showToast(settings.haptics ? 'Haptics on' : 'Haptics off');
      vibrate(20);
    });

    practiceChip.addEventListener('click', () => {
      settings.practice = !settings.practice;
      applyDifficulty();
      syncSettingsUI();
      persist();
      showToast(settings.practice ? 'Practice mode' : 'Practice off');
      if (running){
        running = false;
        paused = false;
        overlay.style.display = 'flex';
        overlayTitle.textContent = 'Mode changed';
        overlaySubtitle.textContent = 'Tap Play / Restart to continue.';
      }
    });

    // Settings modal
    function openSettings(){ settingsModal.classList.add('show'); }
    function closeSettingsModal(){ settingsModal.classList.remove('show'); }

    settingsBtn.addEventListener('click', openSettings);
    closeSettings.addEventListener('click', closeSettingsModal);
    settingsModal.addEventListener('click', (e) => { if (e.target === settingsModal) closeSettingsModal(); });

    tabs.forEach(t => {
      t.addEventListener('click', () => {
        tabs.forEach(x => x.classList.remove('active'));
        t.classList.add('active');
        const tab = t.dataset.tab;
        Object.entries(sections).forEach(([k, el]) => el.classList.toggle('active', k === tab));
      });
    });

    hardToggle.addEventListener('click', () => {
      settings.hard = !settings.hard;
      applyDifficulty();
      syncSettingsUI();
      persist();
      showToast(settings.hard ? 'Hard mode on' : 'Hard mode off');
      if (running){
        running = false;
        paused = false;
        overlay.style.display = 'flex';
        overlayTitle.textContent = 'Mode changed';
        overlaySubtitle.textContent = 'Tap Play / Restart to continue.';
      }
    });

    curveToggle.addEventListener('click', () => {
      settings.curve = !settings.curve;
      syncSettingsUI();
      persist();
      showToast(settings.curve ? 'Difficulty curve on' : 'Difficulty curve off');
    });

    gfxSelect.addEventListener('change', () => {
      settings.gfx = gfxSelect.value;
      syncSettingsUI();
      persist();
      showToast(settings.gfx === 'neon' ? 'Neon style' : 'Clean style');
    });

    // ‚úÖ EarnPro stays untouched: just link to earnpro.html
    earnproBtn.addEventListener('click', () => {
      window.location.href = "earnpro.html";
    });

    // Secret unlock: tap More tab 5 times (within 3 seconds window)
    function registerMoreTap(){
      moreTapCount++;
      clearTimeout(moreTapTimer);
      moreTapTimer = setTimeout(() => { moreTapCount = 0; }, 3000);

      const remaining = Math.max(0, 5 - moreTapCount);
      if (!earnproUnlocked){
        if (remaining > 0) showToast(`Secret‚Ä¶ ${remaining}`);
        if (moreTapCount >= 5){
          earnproUnlocked = true;
          persist();
          syncSettingsUI();
          beep(880, 0.06, 'sine', 0.035);
          beep(1040, 0.06, 'sine', 0.035);
          vibrate(40);
          showToast('Unlocked üîì');
        }
      }
    }
    moreTabBtn.addEventListener('click', registerMoreTap);

    // Docs / legal content (inside same index file)
    const DOCS = {
      about: `
        <h3>About SkyPulse</h3>
        <p><b style="color:var(--text)">SkyPulse</b> is a lightweight browser game built for quick sessions: tap to boost, pass the gates, and chase your best score.</p>
        <div class="hr"></div>
        <h3>How to play</h3>
        <ul>
          <li>Press <code>Space</code>, click, or tap to boost upward.</li>
          <li>Avoid hitting pipes and the ground.</li>
          <li>Try Practice mode to learn the timing.</li>
        </ul>
      `,
      privacy: `
        <h3>Privacy Policy</h3>
        <p>SkyPulse is a browser-based game. We aim to keep data collection minimal.</p>
        <h3>What we store</h3>
        <ul>
          <li><b style="color:var(--text)">Local gameplay stats</b> (best score, attempts, settings) saved in your browser using <code>localStorage</code>.</li>
        </ul>
        <h3>What we don‚Äôt do</h3>
        <ul>
          <li>We do not collect sensitive personal information inside SkyPulse.</li>
          <li>We do not sell personal data.</li>
        </ul>
        <h3>Third-party services</h3>
        <p>If you choose to open EarnPro, that experience may use third-party services (e.g., authentication/analytics) inside its own page. SkyPulse itself does not require login.</p>
        <div class="hr"></div>
        <p><i style="color:var(--muted)">This policy may be updated as features expand.</i></p>
      `,
      terms: `
        <h3>Terms of Service</h3>
        <p>By using SkyPulse, you agree to these basic terms.</p>
        <h3>Use</h3>
        <ul>
          <li>Use the site for lawful purposes only.</li>
          <li>Do not attempt to disrupt, exploit, or reverse engineer the site.</li>
        </ul>
        <h3>Availability</h3>
        <p>SkyPulse is provided ‚Äúas is‚Äù and may change or be unavailable at any time.</p>
        <h3>Liability</h3>
        <p>We are not liable for losses or damages resulting from use or inability to use the site.</p>
        <h3>EarnPro</h3>
        <p>EarnPro is a separate experience accessed via link. Any participation there is subject to its own rules and requirements.</p>
      `,
      contact: `
        <h3>Contact</h3>
        <p>For support or questions, email:</p>
        <p style="margin-top:10px;">
          <a href="mailto:guevara.hijazi0@gmail.com" style="color:var(--text);font-weight:950;text-decoration:none;border:1px solid var(--border);background:rgba(255,255,255,.05);padding:10px 12px;border-radius:12px;display:inline-block;">
            guevara.hijazi0@gmail.com
          </a>
        </p>
      `
    };

    function openDocs(which){
      docsContent.innerHTML = DOCS[which] || DOCS.about;
      // switch to Docs tab
      tabs.forEach(x => x.classList.remove('active'));
      tabs.find(x => x.dataset.tab === 'docs')?.classList.add('active');
      Object.entries(sections).forEach(([k, el]) => el.classList.toggle('active', k === 'docs'));
      openSettings();
    }

    // Footer doc links + More tab doc links
    document.querySelectorAll('[data-doc]').forEach(a => {
      a.addEventListener('click', (e) => {
        e.preventDefault();
        openDocs(a.dataset.doc);
      });
    });

    // Init
    syncSettingsUI();
    resetGame(true);

    // If already unlocked previously
    if (earnproUnlocked) {
      // keep it hidden in UI until More tab is visited (still visible if unlocked)
      // (no action needed; syncSettingsUI handles it)
    }
  </script>
</body>
</html>
