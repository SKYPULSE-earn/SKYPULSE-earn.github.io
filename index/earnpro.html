<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EarnPro - Watch Ads, Earn Money</title>

  <script src="https://cdn.jsdelivr.net/npm/prebid.js@10.25.0/dist/prebid.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <style>
    :root {
      --bg-dark: #0a0e27;
      --bg-surface: #1a1f3a;
      --bg-surface-light: rgba(255,255,255,0.05);
      --text-primary: #f0f4f8;
      --text-muted: #8b92a9;
      --border: rgba(255,255,255,0.10);
      --primary: #3b82f6;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --shadow: 0 20px 60px rgba(0,0,0,0.5);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      width: 100%;
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      overflow: hidden;
    }
    body {
      background-image:
        radial-gradient(600px 400px at 20% 10%, rgba(59,130,246,0.15), transparent 50%),
        radial-gradient(600px 400px at 80% 90%, rgba(16,185,129,0.10), transparent 50%);
    }

    header {
      position: fixed; top: 0; left: 0; right: 0;
      height: 70px;
      background: rgba(10,14,39,0.95);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 30px;
      z-index: 100;
    }
    .header-brand { display: flex; align-items: center; gap: 15px; font-size: 28px; }
    .header-brand h1 { font-size: 22px; font-weight: 800; letter-spacing: -1px; }
    .header-controls { display: flex; align-items: center; gap: 14px; }

    .user-info {
      display: flex; align-items: center; gap: 12px;
      padding: 8px 16px;
      background: var(--bg-surface-light);
      border-radius: 20px;
      border: 1px solid var(--border);
      font-size: 13px;
      font-weight: 600;
    }

    .btn-icon {
      width: 40px; height: 40px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--bg-surface-light);
      color: var(--text-primary);
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px;
      transition: all 0.2s;
    }
    .btn-icon:hover { background: var(--bg-surface); transform: scale(1.05); }

    .container {
      position: fixed;
      top: 70px; left: 0; right: 0; bottom: 0;
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      padding: 16px;
      overflow: hidden;
    }
    .main-content {
      display: flex;
      flex-direction: column;
      gap: 14px;
      overflow-y: auto;
      padding-bottom: 14px;
    }

    /* Compact ad card */
    .ad-card {
      height: 230px;
      background: linear-gradient(135deg, rgba(30,41,59,0.9), rgba(15,23,42,0.9));
      border: 2px solid var(--border);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }
    @media (max-height: 800px) { .ad-card { height: 215px; } }
    @media (max-height: 700px) { .ad-card { height: 195px; } }

    .ad-placeholder { text-align: center; opacity: 0.75; padding: 12px; }
    .ad-placeholder-icon { font-size: 52px; margin-bottom: 10px; }
    .ad-placeholder h3 { font-size: 16px; margin-bottom: 6px; }
    .ad-placeholder p { font-size: 13px; color: var(--text-muted); }

    .ad-loading {
      position: absolute; inset: 0;
      background: rgba(10,14,27,0.95);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
    }
    .spinner {
      width: 44px; height: 44px;
      border: 3px solid var(--bg-surface-light);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .ad-slot { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }

    .ad-badges {
      position: absolute;
      top: 12px; right: 12px;
      display: flex;
      gap: 8px;
    }
    .badge {
      padding: 6px 10px;
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .badge-live, .badge-cpm {
      color: var(--success);
      border-color: rgba(16,185,129,0.3);
    }

    .watch-section {
      background: var(--bg-surface-light);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
    }
    .btn-primary {
      width: 100%;
      padding: 14px 18px;
      background: linear-gradient(135deg, var(--primary), #1d4ed8);
      border: 0;
      border-radius: 12px;
      color: white;
      font-weight: 800;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 12px 30px rgba(59,130,246,0.4);
    }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
    .watch-hint {
      margin-top: 10px;
      font-size: 12px;
      color: var(--text-muted);
      text-align: center;
      min-height: 16px;
    }

    .progress-section { margin-top: 4px; }
    .progress-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 13px;
    }
    .progress-bar {
      height: 8px;
      background: var(--bg-surface-light);
      border-radius: 4px;
      overflow: hidden;
      border: 1px solid var(--border);
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--success));
      border-radius: 4px;
      transition: width 0.6s ease;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 12px;
    }
    .stat-box {
      background: var(--bg-surface-light);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      text-align: center;
    }
    .stat-value { font-size: 22px; font-weight: 900; color: var(--success); }
    .stat-label {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
      font-weight: 600;
      text-transform: uppercase;
    }

    /* Banner message */
    .banner {
      display: none;
      padding: 12px 14px;
      border: 1px solid rgba(16,185,129,0.35);
      background: rgba(16,185,129,0.12);
      border-radius: 12px;
      font-size: 13px;
      line-height: 1.35;
    }
    .banner.show { display: block; }
    .banner b { color: var(--success); }

    /* Auth overlay */
    .auth-overlay {
      position: fixed; inset: 0;
      background: rgba(10,14,27,0.95);
      backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .auth-overlay.show { display: flex; }
    .auth-panel {
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 32px;
      max-width: 380px;
      width: 90%;
    }
    .auth-panel h2 { font-size: 24px; margin-bottom: 8px; font-weight: 800; }
    .auth-panel p { color: var(--text-muted); font-size: 14px; margin-bottom: 20px; }
    .auth-input-group { margin-bottom: 16px; }
    .auth-input-group label {
      display: block;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 6px;
      letter-spacing: 0.5px;
    }
    .auth-input-group input {
      width: 100%;
      padding: 12px 14px;
      background: rgba(0,0,0,0.3);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 14px;
    }
    .auth-input-group input:focus { outline: none; border-color: var(--primary); }
    .auth-error { color: var(--error); font-size: 12px; margin-bottom: 16px; display: none; }
    .auth-buttons { display: flex; gap: 10px; }
    .btn-secondary {
      flex: 1;
      padding: 12px;
      background: var(--bg-surface-light);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-secondary:hover { background: var(--bg-surface); }
    .auth-buttons .btn-primary { flex: 1; padding: 12px; margin: 0; }

    /* Calendar modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(10,14,27,0.70);
      backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1200;
      padding: 16px;
    }
    .modal.show { display: flex; }
    .modal-card {
      width: 100%;
      max-width: 720px;
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .modal-header {
      padding: 14px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
      background: rgba(0,0,0,0.15);
    }
    .modal-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 900;
      letter-spacing: -0.5px;
    }
    .modal-body { padding: 16px; }
    .cal-summary {
      font-size: 12px;
      color: var(--text-muted);
      line-height: 1.4;
      margin-bottom: 12px;
    }
    .cal-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
    }
    .day {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 10px 8px;
      min-height: 54px;
      background: rgba(255,255,255,0.03);
      position: relative;
    }
    .day-num {
      font-size: 12px;
      font-weight: 900;
      opacity: 0.95;
    }
    .day-badge {
      position: absolute;
      right: 8px;
      top: 8px;
      font-size: 10px;
      font-weight: 900;
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.25);
      color: var(--text-muted);
    }
    .day.complete {
      border-color: rgba(16,185,129,0.35);
      background: rgba(16,185,129,0.08);
    }
    .day.complete .day-badge {
      color: var(--success);
      border-color: rgba(16,185,129,0.35);
      background: rgba(16,185,129,0.12);
    }
    .day.today {
      outline: 2px solid rgba(59,130,246,0.45);
      outline-offset: 1px;
    }
    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 14px;
      justify-content: flex-end;
    }
    .mini-btn {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--bg-surface-light);
      color: var(--text-primary);
      font-weight: 800;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 12px;
    }
    .mini-btn:hover { background: var(--bg-surface); transform: translateY(-1px); }

    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--bg-surface-light); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--border); }
  </style>
</head>

<body>
  <header>
    <div class="header-brand">
      <span>üí∞</span>
      <h1>EarnPro</h1>
    </div>
    <div class="header-controls">
      <div class="user-info">
        <span id="userEmail">Not logged in</span>
      </div>
      <button class="btn-icon" id="calendarBtn" title="30-day calendar">üìÖ</button>
      <button class="btn-icon" id="themeToggle" title="Toggle theme">üåô</button>
      <button class="btn-icon" id="logoutBtn" title="Logout" style="display:none;">üö™</button>
    </div>
  </header>

  <div class="auth-overlay" id="authOverlay">
    <div class="auth-panel">
      <h2>Welcome</h2>
      <p>Sign in or create an account to start earning</p>

      <div class="auth-input-group">
        <label>Email</label>
        <input type="email" id="authEmail" placeholder="you@example.com">
      </div>

      <div class="auth-input-group">
        <label>Password</label>
        <input type="password" id="authPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>

      <div class="auth-error" id="authError"></div>

      <div class="auth-buttons">
        <button class="btn-secondary" id="signupBtn">Create</button>
        <button class="btn-primary" id="loginBtn">Sign In</button>
      </div>
    </div>
  </div>

  <div class="modal" id="calendarModal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title">
          <span>üìÖ</span>
          <span>30-Day Streak</span>
        </div>
        <button class="btn-icon" id="calendarClose" title="Close">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="cal-summary" id="calSummary"></div>
        <div class="cal-grid" id="calGrid"></div>
        <div class="modal-actions">
          <button class="mini-btn" id="closeCalendarBottom">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <main class="main-content">
      <div class="banner" id="payoutBanner"></div>

      <div class="ad-card">
        <div class="ad-placeholder" id="adPlaceholder">
          <div class="ad-placeholder-icon">üì∫</div>
          <h3>Ready to Earn</h3>
          <p>Click below to watch an ad</p>
        </div>

        <div class="ad-loading" id="adLoading" style="display:none;">
          <div class="spinner"></div>
          <div id="auctionStatus">Loading...</div>
        </div>

        <div class="ad-slot" id="adSlot" style="display:none;"></div>

        <div class="ad-badges" id="adBadges" style="display:none;">
          <div class="badge badge-live">‚óè LIVE</div>
          <div class="badge badge-cpm" id="cpmBadge">CPM: $0.00</div>
        </div>
      </div>

      <div class="watch-section">
        <button class="btn-primary" id="watchBtn">
          <span>‚ñ∂Ô∏è</span>
          <span id="watchBtnText">Watch Ad & Earn</span>
        </button>
        <div class="watch-hint" id="watchHint">Ready</div>
      </div>

      <div class="progress-section">
        <div class="progress-header">
          <span>Daily Progress</span>
          <span><span id="adsToday">0</span> / <span id="dailyGoal">1000</span></span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill" style="width:0%"></div>
        </div>

        <div class="stats-grid">
          <div class="stat-box">
            <div class="stat-value" id="statStreak">0</div>
            <div class="stat-label">Day #</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="statTotal">0</div>
            <div class="stat-label">Total Ads</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="statEarnings">$0</div>
            <div class="stat-label">Earned</div>
          </div>
        </div>
      </div>
    </main>
  </div>

<script>
  // =========================
  // CONFIG
  // =========================
  const CONFIG = {
    DAILY_GOAL: 1000,        // ‚úÖ 1000 ads = 100%
    CYCLE_DAYS: 30,          // ‚úÖ always 30 days
    AD_DURATION_SEC: 15,
    BID_TIMEOUT_MS: 2500,
    RANDOM_GAP_MIN_SEC: 1,
    RANDOM_GAP_MAX_SEC: 5,
    DEBUG: false,

    // Until you add real bidders, this makes the app still work.
    DEMO_ADS_IF_NO_BIDDERS: true
  };

  // =========================
  // FIREBASE
  // =========================
  const firebaseConfig = {
    apiKey: "AIzaSyCvCtED1HsuXK32Tv-OI7mbZ6kLPMfmCRE",
    authDomain: "adpay-g.firebaseapp.com",
    projectId: "adpay-g",
    storageBucket: "adpay-g.firebasestorage.app",
    messagingSenderId: "35918822550",
    appId: "1:35918822550:web:2e016cb25be882ae2416b7"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // =========================
  // PREBID (hidden bidders for later)
  // =========================
  const SSPS = [
    // Fill later
    // { bidder:"appnexus", params:{ placementId: 123 } }
  ];
  const AD_UNIT_CODE = "earnpro_adunit";

  function initPrebid() {
    if (typeof pbjs === "undefined") return;
    pbjs.que = pbjs.que || [];
    pbjs.que.push(() => {
      pbjs.setConfig({
        priceGranularity: "high",
        enableSendAllBids: true,
        bidderTimeout: CONFIG.BID_TIMEOUT_MS,
        debug: CONFIG.DEBUG
      });
    });
  }
  function buildAdUnit(bidders) {
    return {
      code: AD_UNIT_CODE,
      mediaTypes: { banner: { sizes: [[640, 360]] } },
      bids: bidders.map(b => ({ bidder: b.bidder, params: b.params }))
    };
  }
  async function runAuction(bidders) {
    return new Promise(resolve => {
      if (typeof pbjs === "undefined" || !bidders.length) {
        resolve({ ok: false, msg: "No bidders" });
        return;
      }
      pbjs.que.push(() => {
        try { pbjs.removeAdUnit(AD_UNIT_CODE); } catch (e) {}
        pbjs.addAdUnits([buildAdUnit(bidders)]);
        pbjs.requestBids({
          adUnitCodes: [AD_UNIT_CODE],
          timeout: CONFIG.BID_TIMEOUT_MS,
          bidsBackHandler: () => {
            const top = (pbjs.getHighestCpmBids(AD_UNIT_CODE) || [])[0];
            if (!top) resolve({ ok: false, msg: "No bids" });
            else resolve({ ok: true, bid: top });
          }
        });
      });
    });
  }
  function renderAd(bid) {
    const slot = document.getElementById("adSlot");
    slot.innerHTML = "";
    const iframe = document.createElement("iframe");
    iframe.style.cssText = "width:100%;height:100%;border:0;";
    slot.appendChild(iframe);
    pbjs.que.push(() => {
      try { pbjs.renderAd(iframe.contentWindow.document, bid.adId); }
      catch (e) { slot.innerHTML = `<div style="padding:16px;text-align:center;">Ad render failed</div>`; }
    });
  }

  // =========================
  // HELPERS
  // =========================
  const pad2 = (n) => String(n).padStart(2, "0");
  function dayKey(d = new Date()) {
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }
  function dateFromDayKey(key) {
    const [y,m,d] = key.split("-").map(Number);
    return new Date(y, m-1, d);
  }
  function midnight(d = new Date()) {
    return new Date(d.getFullYear(), d.getMonth(), d.getDate());
  }
  function daysBetween(a, b) {
    const ms = 24 * 60 * 60 * 1000;
    return Math.floor((midnight(b) - midnight(a)) / ms);
  }
  function clamp(n, lo, hi) { return Math.max(lo, Math.min(hi, n)); }
  function randDelayMs() {
    const min = CONFIG.RANDOM_GAP_MIN_SEC;
    const max = CONFIG.RANDOM_GAP_MAX_SEC;
    return (Math.floor(Math.random() * (max - min + 1)) + min) * 1000;
  }

  // =========================
  // USER + FIRESTORE STATE
  // =========================
  let currentUser = null;
  let userDocUnsub = null;

  // This mirrors what is in Firestore (users/{uid})
  let userState = null;

  function defaultCycle(startDayKey) {
    return {
      startDay: startDayKey,
      completed: Array(CONFIG.CYCLE_DAYS).fill(false), // 30 booleans
      dayCounts: Array(CONFIG.CYCLE_DAYS).fill(0),     // 30 counts
      lastDayKey: startDayKey,
      finished: false,
      finishedAt: null
    };
  }

  async function ensureUserDoc(uid, email) {
    const ref = db.collection("users").doc(uid);
    const snap = await ref.get();
    if (!snap.exists) {
      const start = dayKey();
      await ref.set({
        email,
        totalAds: 0,
        totalEarnings: 0,
        cycle: defaultCycle(start),
        updated: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
    } else {
      // If cycle missing, add it
      const data = snap.data() || {};
      if (!data.cycle || !data.cycle.startDay) {
        const start = dayKey();
        await ref.set({ cycle: defaultCycle(start) }, { merge: true });
      }
    }
  }

  function subscribeUserDoc(uid) {
    if (userDocUnsub) userDocUnsub();
    const ref = db.collection("users").doc(uid);
    userDocUnsub = ref.onSnapshot((snap) => {
      if (!snap.exists) return;
      userState = snap.data();
      // On every update, enforce streak rules + update UI
      enforceStreakRules().catch(() => {});
      updateUIFromState();
      if (isCalendarOpen()) renderCalendar();
    });
  }

  function getCycle() {
    return (userState && userState.cycle) ? userState.cycle : defaultCycle(dayKey());
  }

  // =========================
  // STREAK / 30-DAY RULES
  // =========================
  async function enforceStreakRules() {
    if (!currentUser || !userState) return;

    const ref = db.collection("users").doc(currentUser.uid);
    const cycle = getCycle();
    const todayKey = dayKey();
    const start = dateFromDayKey(cycle.startDay);

    // Calculate which day in the 30-day streak we are on (1..30)
    const dayIndex0 = clamp(daysBetween(start, new Date()), 0, CONFIG.CYCLE_DAYS-1);

    // If user missed any previous day in the current cycle => reset cycle today.
    // Example: today is day 5, but day 3 wasn't completed => reset.
    if (dayIndex0 > 0) {
      for (let i = 0; i < dayIndex0; i++) {
        if (!cycle.completed[i]) {
          const newStart = todayKey;
          await ref.set({
            cycle: defaultCycle(newStart),
            updated: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
          return;
        }
      }
    }

    // If cycle finished and today is beyond day 30, start a new cycle automatically.
    // (We still keep the old data in the doc only if you want history later; for now we just restart.)
    const totalDaysSinceStart = daysBetween(start, new Date());
    if (totalDaysSinceStart >= CONFIG.CYCLE_DAYS) {
      const newStart = todayKey;
      await ref.set({
        cycle: defaultCycle(newStart),
        updated: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
      return;
    }

    // Keep lastDayKey current
    if (cycle.lastDayKey !== todayKey) {
      await ref.set({
        "cycle.lastDayKey": todayKey,
        updated: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
    }
  }

  function currentDayIndex0() {
    const cycle = getCycle();
    const start = dateFromDayKey(cycle.startDay);
    return clamp(daysBetween(start, new Date()), 0, CONFIG.CYCLE_DAYS-1);
  }

  function isCycleComplete() {
    const cycle = getCycle();
    return !!cycle.finished;
  }

  // =========================
  // UI updates
  // =========================
  function setHint(html) { document.getElementById("watchHint").innerHTML = html; }
  function disableWatch(text) {
    document.getElementById("watchBtn").disabled = true;
    document.getElementById("watchBtnText").textContent = text;
  }
  function enableWatch() {
    document.getElementById("watchBtn").disabled = false;
    document.getElementById("watchBtnText").textContent = "Watch Ad & Earn";
    setHint("Ready");
  }

  function showPayoutMessage() {
    const el = document.getElementById("payoutBanner");
    el.classList.add("show");
    el.innerHTML = `
      <b>Congratulations!</b> You completed the 30-day streak.
      You should shortly receive an email about your money.`;
  }

  function hidePayoutMessage() {
    const el = document.getElementById("payoutBanner");
    el.classList.remove("show");
    el.innerHTML = "";
  }

  function updateUIFromState() {
    document.getElementById("dailyGoal").textContent = CONFIG.DAILY_GOAL;

    if (!userState) return;

    const cycle = getCycle();
    const day0 = currentDayIndex0();

    const todayCount = Number(cycle.dayCounts?.[day0] || 0);
    document.getElementById("adsToday").textContent = todayCount;

    const pct = Math.min((todayCount / CONFIG.DAILY_GOAL) * 100, 100);
    document.getElementById("progressFill").style.width = pct + "%";

    const total = Number(userState.totalAds || 0);
    const earned = Number(userState.totalEarnings || 0);
    document.getElementById("statTotal").textContent = String(total);
    document.getElementById("statEarnings").textContent = `$${earned.toFixed(2)}`;

    // "Streak" box shows which day number you're on (1..30)
    document.getElementById("statStreak").textContent = String(day0 + 1);

    if (cycle.finished) showPayoutMessage();
    else hidePayoutMessage();
  }

  // =========================
  // Calendar modal (30 days)
  // =========================
  function isCalendarOpen() {
    return document.getElementById("calendarModal").classList.contains("show");
  }
  function openCalendar() {
    document.getElementById("calendarModal").classList.add("show");
    document.getElementById("calendarModal").setAttribute("aria-hidden", "false");
    renderCalendar();
  }
  function closeCalendar() {
    document.getElementById("calendarModal").classList.remove("show");
    document.getElementById("calendarModal").setAttribute("aria-hidden", "true");
  }

  function renderCalendar() {
    const grid = document.getElementById("calGrid");
    const summary = document.getElementById("calSummary");
    grid.innerHTML = "";

    if (!userState) {
      summary.textContent = "Loading...";
      return;
    }

    const cycle = getCycle();
    const startDay = cycle.startDay;
    const startDate = dateFromDayKey(startDay);
    const today0 = currentDayIndex0();

    let completedCount = 0;
    for (let i = 0; i < CONFIG.CYCLE_DAYS; i++) if (cycle.completed?.[i]) completedCount++;

    const remaining = CONFIG.CYCLE_DAYS - completedCount;

    summary.innerHTML = `
      Start: <b>${startDay}</b><br>
      Completed days: <b>${completedCount}</b> / ${CONFIG.CYCLE_DAYS} &nbsp;‚Ä¢&nbsp; Remaining: <b>${remaining}</b><br>
      Rule: You must hit <b>${CONFIG.DAILY_GOAL}</b> ads per day. If you miss a day, the 30-day streak resets.
    `;

    for (let i = 0; i < CONFIG.CYCLE_DAYS; i++) {
      const d = new Date(startDate);
      d.setDate(d.getDate() + i);
      const label = dayKey(d);

      const cell = document.createElement("div");
      const complete = !!cycle.completed?.[i];
      const isToday = (i === today0);

      cell.className = "day" + (complete ? " complete" : "") + (isToday ? " today" : "");
      cell.innerHTML = `
        <div class="day-num">Day ${i+1}</div>
        <div class="day-badge">${complete ? "100%" : "‚Äî"}</div>
        <div style="margin-top:6px;font-size:11px;color:var(--text-muted);">${label}</div>
      `;
      grid.appendChild(cell);
    }

    if (cycle.finished) {
      summary.innerHTML += `<br><br><b style="color:var(--success);">Congratulations!</b> You completed the 30-day streak.`;
    }
  }

  // =========================
  // AD FLOW (one at a time + finish counts)
  // =========================
  let isAdPlaying = false;
  let readyTimeout = null;

  async function watchAd() {
    if (!currentUser || !userState) return;
    if (isAdPlaying) return;
    if (isCycleComplete()) {
      setHint("Cycle complete. Start again tomorrow (or reset cycle).");
      return;
    }

    if (readyTimeout) { clearTimeout(readyTimeout); readyTimeout = null; }

    isAdPlaying = true;
    disableWatch("Loading...");
    setHint("Finish this ad to unlock the next one");

    document.getElementById("adPlaceholder").style.display = "none";
    document.getElementById("adLoading").style.display = "flex";
    document.getElementById("adSlot").style.display = "none";
    document.getElementById("adBadges").style.display = "none";
    document.getElementById("auctionStatus").textContent = "Loading...";

    const bidders = SSPS;

    // If no bidders yet, run demo ad so the app still works
    if (!bidders.length && CONFIG.DEMO_ADS_IF_NO_BIDDERS) {
      runDemoAd();
      return;
    }

    const result = await runAuction(bidders);
    if (!result.ok) {
      // If auction fails but demo enabled, fallback to demo
      if (CONFIG.DEMO_ADS_IF_NO_BIDDERS) {
        runDemoAd();
        return;
      }

      document.getElementById("auctionStatus").textContent = result.msg || "No bids";
      document.getElementById("adLoading").style.display = "none";
      document.getElementById("adPlaceholder").style.display = "flex";
      finishAdFlow();
      return;
    }

    document.getElementById("adLoading").style.display = "none";
    document.getElementById("adSlot").style.display = "flex";
    document.getElementById("adBadges").style.display = "flex";
    document.getElementById("cpmBadge").textContent = `CPM: $${(result.bid.cpm || 0).toFixed(2)}`;
    renderAd(result.bid);

    let remaining = CONFIG.AD_DURATION_SEC;
    disableWatch(`Watching... ${remaining}s`);

    const timer = setInterval(() => {
      remaining--;
      disableWatch(`Watching... ${Math.max(remaining, 0)}s`);
      if (remaining <= 0) {
        clearInterval(timer);
        completeAdAndSave(result.bid);
      }
    }, 1000);
  }

  function runDemoAd() {
    document.getElementById("auctionStatus").textContent = "Demo ad (no bidders yet)";
    document.getElementById("adLoading").style.display = "none";
    document.getElementById("adSlot").style.display = "flex";
    document.getElementById("adBadges").style.display = "flex";
    document.getElementById("cpmBadge").textContent = `CPM: $0.00`;

    const slot = document.getElementById("adSlot");
    slot.innerHTML = `
      <div style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;gap:10px;opacity:0.9;">
        <div style="font-size:54px;">üì∫</div>
        <div style="font-weight:900;font-size:16px;">Demo Ad</div>
        <div style="color:var(--text-muted);font-size:12px;max-width:360px;">
          This counts as a completed ad for testing until Prebid bidders are added.
        </div>
      </div>
    `;

    let remaining = CONFIG.AD_DURATION_SEC;
    disableWatch(`Watching... ${remaining}s`);

    const timer = setInterval(() => {
      remaining--;
      disableWatch(`Watching... ${Math.max(remaining, 0)}s`);
      if (remaining <= 0) {
        clearInterval(timer);
        completeAdAndSave({ bidder: "demo", cpm: 0 });
      }
    }, 1000);
  }

  async function completeAdAndSave(bid) {
    if (!currentUser || !userState) {
      finishAdFlow();
      return;
    }

    const ref = db.collection("users").doc(currentUser.uid);

    // We update using current snapshot values (simple + works with your rules)
    const cycle = getCycle();
    const day0 = currentDayIndex0();

    const nextCycle = JSON.parse(JSON.stringify(cycle));
    nextCycle.dayCounts = Array.isArray(nextCycle.dayCounts) ? nextCycle.dayCounts : Array(CONFIG.CYCLE_DAYS).fill(0);
    nextCycle.completed = Array.isArray(nextCycle.completed) ? nextCycle.completed : Array(CONFIG.CYCLE_DAYS).fill(false);

    nextCycle.dayCounts[day0] = Number(nextCycle.dayCounts[day0] || 0) + 1;

    // Mark day complete if it hits goal
    if (!nextCycle.completed[day0] && nextCycle.dayCounts[day0] >= CONFIG.DAILY_GOAL) {
      nextCycle.completed[day0] = true;
    }

    // If Day 30 completed now => finish cycle
    if (day0 === CONFIG.CYCLE_DAYS - 1 && nextCycle.completed[day0]) {
      nextCycle.finished = true;
      nextCycle.finishedAt = new Date().toISOString();
    }

    const nextTotalAds = Number(userState.totalAds || 0) + 1;

    // Keep earnings simple (you can change later)
    const earnedNow = (Number(bid?.cpm || 0) / 1000);
    const nextEarnings = Number(userState.totalEarnings || 0) + earnedNow;

    await ref.set({
      totalAds: nextTotalAds,
      totalEarnings: nextEarnings,
      cycle: nextCycle,
      updated: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });

    // UI + close ad
    if (nextCycle.finished) {
      showPayoutMessage();
    }
    finishAdFlow();
  }

  function finishAdFlow() {
    document.getElementById("adPlaceholder").style.display = "flex";
    document.getElementById("adSlot").style.display = "none";
    document.getElementById("adBadges").style.display = "none";
    document.getElementById("adLoading").style.display = "none";

    const wait = randDelayMs();
    const started = Date.now();

    isAdPlaying = false;
    disableWatch("Wait...");
    setHint(`Next ad available in <span id="cooldownText">${Math.ceil(wait/1000)}s</span>`);

    const countdown = setInterval(() => {
      const left = Math.max(0, wait - (Date.now() - started));
      const el = document.getElementById("cooldownText");
      if (el) el.textContent = `${Math.ceil(left/1000)}s`;
      if (left <= 0) clearInterval(countdown);
    }, 200);

    readyTimeout = setTimeout(() => {
      enableWatch();
      updateUIFromState();
    }, wait);
  }

  // =========================
  // AUTH + THEME + MODAL
  // =========================
  function initAuth() {
    const overlay = document.getElementById("authOverlay");
    const emailEl = document.getElementById("authEmail");
    const passEl = document.getElementById("authPassword");
    const errEl = document.getElementById("authError");

    document.getElementById("loginBtn").onclick = () => {
      errEl.style.display = "none";
      auth.signInWithEmailAndPassword(emailEl.value, passEl.value).catch(e => {
        errEl.textContent = e.message;
        errEl.style.display = "block";
      });
    };

    document.getElementById("signupBtn").onclick = () => {
      errEl.style.display = "none";
      auth.createUserWithEmailAndPassword(emailEl.value, passEl.value).catch(e => {
        errEl.textContent = e.message;
        errEl.style.display = "block";
      });
    };

    document.getElementById("logoutBtn").onclick = () => auth.signOut();

    auth.onAuthStateChanged(async (user) => {
      currentUser = user;

      if (!user) {
        userState = null;
        if (userDocUnsub) userDocUnsub();
        overlay.classList.add("show");
        document.getElementById("logoutBtn").style.display = "none";
        document.getElementById("userEmail").textContent = "Not logged in";
        hidePayoutMessage();
        return;
      }

      overlay.classList.remove("show");
      document.getElementById("userEmail").textContent = user.email;
      document.getElementById("logoutBtn").style.display = "block";

      await ensureUserDoc(user.uid, user.email);
      subscribeUserDoc(user.uid);

      document.getElementById("watchBtn").disabled = false;
      updateUIFromState();
    });
  }

  function initTheme() {
    const key = "earnpro:theme";
    const isDark = (localStorage.getItem(key) || "dark") !== "light";
    document.documentElement.style.colorScheme = isDark ? "dark" : "light";
    document.getElementById("themeToggle").onclick = () => {
      const curr = localStorage.getItem(key) || "dark";
      const next = curr === "light" ? "dark" : "light";
      localStorage.setItem(key, next);
      document.documentElement.style.colorScheme = next;
    };
  }

  function initCalendar() {
    document.getElementById("calendarBtn").onclick = openCalendar;
    document.getElementById("calendarClose").onclick = closeCalendar;
    document.getElementById("closeCalendarBottom").onclick = closeCalendar;
    document.getElementById("calendarModal").addEventListener("click", (e) => {
      if (e.target.id === "calendarModal") closeCalendar();
    });
  }

  // =========================
  // INIT
  // =========================
  function init() {
    initPrebid();
    initAuth();
    initTheme();
    initCalendar();

    document.getElementById("watchBtn").onclick = watchAd;
    disableWatch("Sign in to start");
    setHint("Sign in to continue");
    document.getElementById("dailyGoal").textContent = CONFIG.DAILY_GOAL;
  }

  document.readyState === "loading"
    ? document.addEventListener("DOMContentLoaded", init)
    : init();
</script>
</body>
</html>
<meta name="google-adsense-account" content="ca-pub-4828354236438737">